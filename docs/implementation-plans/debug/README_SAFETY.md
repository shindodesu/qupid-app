# セーフティ機能 実装ドキュメント

## 📋 概要

このドキュメントでは、Qupidアプリのセーフティ（通報・ブロック）機能の実装について説明します。

## 🎯 実装された機能

### 1. 通報機能
- ユーザーの通報（複数の理由から選択）
- カスタム理由の入力
- 通報履歴の確認
- 通報ステータスの表示（対応待ち・審査中・解決済み・却下）
- 運営からの返信確認

### 2. ブロック機能
- ユーザーのブロック
- ブロック一覧の表示
- ブロック解除
- ブロック時の警告メッセージ表示

### 3. セーフティ管理ページ (`/safety`)
- ブロックしたユーザー一覧
- 通報履歴一覧
- タブでの切り替え
- ブロック解除機能
- ヘルプリンク

### 4. 統合機能
- 検索結果のユーザーカードから通報・ブロック
- マッチページから通報・ブロック
- チャット画面から通報・ブロック
- ブロック後の自動リダイレクト
- 検索結果からのブロックユーザー除外

## 📁 ファイル構造

```
frontend/src/
├── types/
│   └── safety.ts                      # セーフティ関連の型定義
├── lib/
│   └── api/
│       └── safety.ts                  # セーフティAPIクライアント
├── components/
│   └── features/
│       └── safety/
│           ├── ReportDialog.tsx       # 通報ダイアログ
│           ├── BlockConfirm.tsx       # ブロック確認ダイアログ
│           ├── SafetyList.tsx         # セーフティ一覧
│           └── index.ts               # エクスポート
└── app/
    └── (dashboard)/
        └── safety/
            └── page.tsx               # セーフティ管理ページ
```

## 🔌 APIエンドポイント

### 通報関連
- `POST /reports` - ユーザー通報
- `GET /reports/my` - 自分の通報一覧
- `GET /reports/{id}` - 通報詳細

### ブロック関連
- `POST /blocks` - ユーザーブロック
- `GET /blocks/my` - ブロック一覧
- `DELETE /blocks/{user_id}` - ブロック解除

### 管理者用（将来実装）
- `GET /admin/reports` - 全通報一覧
- `PUT /admin/reports/{id}` - 通報ステータス更新

## 🚀 使用方法

### ユーザーの通報

1. **検索結果・マッチ一覧・チャット画面から**
   - ユーザーカード右上の「⋮」メニューをクリック
   - 「通報する」を選択
   - 通報理由を選択（または入力）
   - 「通報する」ボタンをクリック

2. **通報履歴の確認**
   - `/safety` にアクセス
   - 「通報履歴」タブを選択
   - 過去の通報とステータスを確認

### ユーザーのブロック

1. **ブロック実行**
   - ユーザーカード右上の「⋮」メニューをクリック
   - 「ブロックする」を選択
   - 確認ダイアログで内容を確認
   - 「ブロックする」ボタンをクリック

2. **ブロック効果**
   - お互いのプロフィールが表示されなくなる
   - メッセージの送受信ができなくなる
   - いいねの送信ができなくなる
   - 検索結果に表示されなくなる

3. **ブロック解除**
   - `/safety` にアクセス
   - 「ブロック一覧」タブを選択
   - ブロックを解除したいユーザーの「ブロック解除」ボタンをクリック

## 🎨 コンポーネントの使用例

### ReportDialog

```tsx
import { ReportDialog } from '@/components/features/safety'

const [showDialog, setShowDialog] = useState(false)

<ReportDialog
  isOpen={showDialog}
  onClose={() => setShowDialog(false)}
  targetUserId={123}
  targetUserName="ユーザー名"
/>
```

### BlockConfirm

```tsx
import { BlockConfirm } from '@/components/features/safety'

const [showConfirm, setShowConfirm] = useState(false)

<BlockConfirm
  isOpen={showConfirm}
  onClose={() => setShowConfirm(false)}
  targetUserId={123}
  targetUserName="ユーザー名"
  onSuccess={() => {
    // ブロック成功後の処理
    router.push('/search')
  }}
/>
```

### SafetyList

```tsx
import { SafetyList } from '@/components/features/safety'

<SafetyList />
```

## 🎨 UIの特徴

### 通報ダイアログ
- **通報理由の選択**
  - 不適切なメッセージ
  - ハラスメント
  - スパム・宣伝
  - 偽のプロフィール
  - その他（カスタム入力）

- **注意事項の表示**
  - 運営チームによる確認
  - 虚偽の通報の禁止
  - コミュニティガイドラインへのリンク

- **バリデーション**
  - 理由の必須チェック
  - 文字数制限（1000文字）

### ブロック確認ダイアログ
- **ブロックの効果を明示**
  - プロフィールの非表示
  - メッセージの不可
  - いいねの不可
  - 検索結果からの除外

- **確認プロセス**
  - 明確な確認メッセージ
  - キャンセル可能
  - 解除可能であることを明示

### セーフティ一覧
- **タブ切り替え**
  - ブロック一覧
  - 通報履歴

- **ブロック一覧**
  - ブロックしたユーザー名
  - ブロック日時
  - ブロック解除ボタン

- **通報履歴**
  - 通報したユーザー名
  - 通報理由
  - ステータスバッジ
  - 運営からの返信（あれば）

## ⚡ 技術的な実装ポイント

### 1. モーダル管理
各ページで独立した状態管理：
```typescript
const [showReportDialog, setShowReportDialog] = useState(false)
const [showBlockConfirm, setShowBlockConfirm] = useState(false)
```

### 2. 楽観的更新
ブロック実行後、即座にキャッシュを無効化：
```typescript
onSuccess: () => {
  queryClient.invalidateQueries({ queryKey: ['blocks', 'my'] })
  queryClient.invalidateQueries({ queryKey: ['search'] })
  queryClient.invalidateQueries({ queryKey: ['conversations'] })
  queryClient.invalidateQueries({ queryKey: ['matches'] })
}
```

### 3. 確認ダイアログ
破壊的な操作には必ず確認を求める：
- ブロック実行時の詳細な説明
- キャンセルボタンの提供
- 明確な警告メッセージ

### 4. エラーハンドリング
- API エラーの適切な表示
- ユーザーフレンドリーなエラーメッセージ
- 再試行の案内

## 🔒 セキュリティ

### クライアント側
- ✅ バリデーション（文字数制限など）
- ✅ XSS対策（入力のサニタイズ）
- ✅ 確認ダイアログによる誤操作防止

### サーバー側（既実装）
- ✅ 自分自身への通報・ブロックの防止
- ✅ 重複ブロックの防止
- ✅ 通報者の匿名性保護
- ✅ 管理者権限の確認

## 🎯 通報理由の選択肢

1. **不適切なメッセージ** - 性的・暴力的なメッセージ
2. **ハラスメント** - 継続的な迷惑行為
3. **スパム・宣伝** - 広告・営業活動
4. **偽のプロフィール** - なりすまし・虚偽情報
5. **その他** - カスタム理由を入力

## 🔄 ブロックの影響範囲

ブロックを実行すると、以下の機能で相互作用が制限されます：

### 検索機能
- ✅ ブロックしたユーザーが検索結果に表示されない
- ✅ ブロックされたユーザーからも検索されない

### マッチング機能
- ✅ お互いにいいねを送信できない
- ✅ 既存のマッチが解除される（実装予定）

### チャット機能
- ✅ メッセージの送受信ができない
- ✅ 会話一覧から非表示（実装予定）

### プロフィール閲覧
- ✅ お互いのプロフィールが閲覧できない

## 📊 ステータス管理

### 通報ステータス

| ステータス | 説明 | バッジ色 |
|----------|------|---------|
| open | 対応待ち | 赤（デフォルト） |
| reviewing | 審査中 | ピンク（セカンダリ） |
| resolved | 解決済み | 緑（サクセス） |
| rejected | 却下 | グレー（アウトライン） |

## 🐛 トラブルシューティング

### 通報が送信できない
- ネットワーク接続を確認
- 通報理由を選択または入力したか確認
- 文字数制限（1000文字）を超えていないか確認

### ブロックが実行できない
- 既にブロック済みでないか確認
- ネットワーク接続を確認
- ページをリロードして再試行

### ブロックが解除できない
- ネットワーク接続を確認
- ページをリロードして再試行

## 🚧 今後の拡張予定

### Phase 1: 管理者機能
- 管理者ダッシュボード
- 通報の審査・処理
- ユーザーへの警告・アカウント停止

### Phase 2: 通知機能
- 通報処理完了時の通知
- 運営からの返信通知

### Phase 3: 自動処理
- 複数回通報されたユーザーの自動警告
- パターン検出による自動フラグ

### Phase 4: 統計・分析
- 通報統計の可視化
- 問題のパターン分析
- コミュニティ健全性指標

## 📈 成功指標

- ✅ 通報送信成功率 > 99%
- ✅ ブロック実行成功率 > 99%
- ✅ UI応答速度 < 300ms
- ✅ 誤操作率 < 1%
- ✅ ブロック後の即時反映

## 🎓 ユーザーガイダンス

### 通報すべき行為
- 性的・暴力的なコンテンツ
- ハラスメント・いじめ
- スパム・宣伝行為
- なりすまし・詐欺
- その他の利用規約違反

### ブロックすべき状況
- 不快なメッセージを送ってくる
- 継続的な迷惑行為
- コミュニケーションを取りたくない相手
- その他の不快な行為

### 注意事項
- 虚偽の通報は利用規約違反となります
- ブロックは後から解除できます
- 運営チームが適切に対応します
- 緊急の場合は直接サポートに連絡してください

## 📚 統合箇所

### 1. 検索ページ (`/search`)
- UserCard コンポーネントにメニューボタンを追加
- 通報・ブロックダイアログを統合

### 2. マッチページ (`/matches`)
- マッチカードにメニューボタンを追加
- 通報・ブロックダイアログを統合
- ブロック後の自動更新

### 3. チャット画面 (`/chat/[id]`)
- ヘッダーにメニューボタンを追加
- 通報・ブロックダイアログを統合
- ブロック後、チャット一覧に自動リダイレクト

### 4. プロフィールページ (`/profile`)
- セーフティページへのリンク追加

### 5. ダッシュボードナビゲーション
- セーフティページへのナビゲーション追加

## 🔄 データフロー

### 通報フロー
```
ユーザー → 通報ダイアログ → 理由選択 → 送信
    ↓
バックエンドAPI → データベース保存 → 通報ID返却
    ↓
成功通知 → ダイアログ閉じる → キャッシュ更新
```

### ブロックフロー
```
ユーザー → ブロック確認 → 確認 → 送信
    ↓
バックエンドAPI → データベース保存 → ブロックID返却
    ↓
成功通知 → 全キャッシュ無効化 → UI更新
    ↓
検索結果・マッチ・チャットからブロックユーザー除外
```

## 🧪 テスト推奨項目

実装完了後、以下を確認してください：

### 通報機能
1. **通報ダイアログの表示**
   - 検索結果から開く
   - マッチページから開く
   - チャット画面から開く

2. **通報理由の選択**
   - プリセット理由の選択
   - カスタム理由の入力
   - バリデーションエラーの表示

3. **通報送信**
   - 成功時の通知
   - エラー時の表示
   - 通報履歴への反映

### ブロック機能
1. **ブロック確認ダイアログの表示**
   - 各画面から開く
   - 効果の説明表示

2. **ブロック実行**
   - 成功時の通知
   - 検索結果からの除外
   - マッチからの除外
   - チャットからの除外

3. **ブロック解除**
   - セーフティページから解除
   - 解除後の再表示

## 📊 パフォーマンス

- ✅ React Query によるキャッシュ管理
- ✅ ブロック後の即時UI反映
- ✅ 効率的なクエリ無効化
- ✅ 楽観的更新によるUX向上

## 🔒 プライバシー保護

- ✅ 通報者の匿名性を保護
- ✅ ブロック状況は他人に非公開
- ✅ 通報内容は運営のみ閲覧可能
- ✅ 個人情報の適切な管理

## 📝 注意事項

### ユーザー向け
1. **虚偽の通報は禁止**
   - 利用規約違反となります
   - 悪質な場合はアカウント停止の可能性があります

2. **適切な使用**
   - 本当に問題がある場合のみ使用
   - 意見の相違だけでの通報は避ける

3. **ブロックの影響**
   - 一度ブロックすると相互作用が制限される
   - 解除は可能だが、関係修復は難しい

### 開発者向け
1. **キャッシュの無効化**
   - ブロック後は関連する全キャッシュを無効化
   - 検索・マッチ・チャットのクエリを更新

2. **エラーハンドリング**
   - API エラーの適切な処理
   - ユーザーフレンドリーなメッセージ

3. **セキュリティ**
   - クライアント側のバリデーション
   - サーバー側でも検証（二重チェック）

## 📚 参考資料

- [実装計画書: 通報・ブロックAPI](../../docs/implementation-plans/05-report-block.md)
- [実装計画書: フロントエンドセーフティ](../../docs/implementation-plans/frontend/05-safety.md)
- [要件定義書](../../docs/requirements.md)

## 👥 開発者

Qupid開発チーム

## 📅 更新履歴

- 2025-10-15: セーフティ機能実装完了
  - 通報ダイアログ
  - ブロック確認ダイアログ
  - セーフティ管理ページ
  - 検索・マッチ・チャットとの統合
  - ダッシュボードナビゲーション更新

