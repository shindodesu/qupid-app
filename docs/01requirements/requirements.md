# Qupid プロジェクト要件定義書（改訂版）

## 📋 プロジェクト概要

* **プロジェクト名**：Qupid（キューピッド）
* **目的**：九州大学内のLGBTQ当事者学生が、匿名で安心して恋人・友人とつながることを支援するマッチングWebアプリを提供する
* **開発形態**：Webアプリ（将来的にネイティブ展開も想定）
* **使用技術**：
  - **バックエンド**: Python + FastAPI + PostgreSQL + SQLAlchemy + Alembic
  - **フロントエンド**: React/Next.js + Tailwind CSS（予定）
* **開発環境**：CURSORエディタ / GitHub
* **ホスティング予定**：Render or Railway（API） + Vercel or Netlify（フロント）

---

## ✅ 想定ユーザー

* 九州大学のLGBTQ+当事者学生
* 恋人／友達づくりをしたい学生
* 匿名・安全に人とつながりたい学生
* 学内限定で安心してマッチングしたい学生

---

## 🧩 機能要件（MVP対象）

### 1. 認証・プロフィール機能（✅実装完了）
* 九州大学のメールアドレス（@s.kyushu-u.ac.jp）での認証
* **パスワード認証**: メールアドレスとパスワードによるログイン
* **メール認証コード方式**: 6桁の認証コードによるメール認証
* **ハイブリッド認証システム**: パスワード認証とメール認証の両方に対応
* 匿名プロフィール登録（ニックネーム、学年、学部、自己紹介等）
* プロフィール編集機能
* アバター画像のアップロード・管理
* JWT認証によるセキュアなセッション管理

### 2. タグ管理機能
* ユーザーが自由にタグを作成・管理
* プロフィールにタグを追加・削除
* タグベースでの検索・フィルタリング
* 将来的なAI自動タグ生成の基盤

### 3. ユーザー検索・フィルター機能
* タグや属性（学部・学年など）で絞り込み検索
* フリーテキスト検索（ニックネーム、自己紹介）
* 複数条件での絞り込み
* ページネーション対応
* おすすめユーザー機能

### 4. いいね・マッチング機能
* ユーザー一覧表示・いいね送信
* 両想い時にマッチング成立
* **マッチ成立時にトークルームを自動生成**（✅ いいね送信APIでマッチ検知時に会話を自動作成）
* マッチしたユーザー一覧取得
* いいね履歴の管理
* マッチング状況の確認

### 5. チャット機能（✅実装完了）
* マッチしたユーザー間での1対1チャット
* **リアルタイム通信**: WebSocketによるリアルタイムメッセージ配信
* メッセージ送信・受信（テキストメッセージ）
* **音声メッセージ**: 音声ファイルのアップロード・送信機能
* メッセージ履歴の取得
* 既読管理機能
* 未読メッセージ数の表示
* **タイピングインジケーター**: 相手が入力中であることを表示
* **オンライン状態管理**: ユーザーのオンライン/オフライン状態の表示

### 6. セーフティ機能
* 不適切ユーザーへの通報機能
* 特定ユーザーのブロック機能
* 通報の管理・処理（管理者用）
* ブロックユーザーとの相互作用制限

### 7. 管理者機能（✅実装完了）
* 通報の確認・処理
* ユーザー管理
* システム統計

### 8. ファイルアップロード機能（✅実装完了）
* **音声ファイルアップロード**: チャットでの音声メッセージ送信用（MP3, WAV, OGG, M4A形式対応）
* **画像ファイルアップロード**: プロフィール画像やチャット内画像送信用（JPEG, PNG, GIF, WebP形式対応）
* **アバター画像アップロード**: プロフィール画像の設定・更新
* ファイルサイズ制限（10MB）
* セキュアなファイル保存・配信

### 9. PWA対応（✅実装完了）
* オフライン対応
* ホーム画面へのインストール機能
* サービスワーカーによるキャッシュ管理
* プッシュ通知対応準備（基盤実装済み）

---

## 🛠️ 技術要件

### バックエンド
* **フレームワーク**: FastAPI
* **データベース**: PostgreSQL
* **ORM**: SQLAlchemy 2.0（非同期）
* **認証**: JWT（PyJWT）
* **設定管理**: Pydantic Settings
* **マイグレーション**: Alembic
* **コンテナ**: Docker & Docker Compose

### フロントエンド（✅実装完了）
* **フレームワーク**: React + Next.js 15（App Router）
* **スタイリング**: Tailwind CSS 4
* **状態管理**: Zustand
* **API通信**: Fetch API + React Query（TanStack Query）
* **UIコンポーネント**: Headless UI + Radix UI
* **アニメーション**: Framer Motion
* **PWA**: next-pwa（サービスワーカー対応）
* **エラー監視**: Sentry（Next.js統合）

### インフラ（✅デプロイ完了）
* **開発環境**: Docker Compose
* **本番環境**: Render（API）+ Vercel（フロント）
* **データベース**: PostgreSQL（本番環境、Render）
* **エラー監視**: Sentry（バックエンド・フロントエンド両方）
* **CORS設定**: 環境変数による動的設定、VercelプレビューURL自動許可

---

## 📊 データベース設計

### 主要テーブル
* **users**: ユーザー基本情報（パスワードハッシュ、プロフィール情報、オンライン状態等）
* **email_verifications**: メール認証コード管理（認証コード、有効期限、検証状態）
* **tags**: タグマスター
* **user_tags**: ユーザーとタグの関連（多対多）
* **likes**: いいね情報
* **conversations**: 会話
* **conversation_members**: 会話メンバー
* **messages**: メッセージ（テキスト、音声ファイルURL等）
* **reports**: 通報情報
* **blocks**: ブロック情報

### 設計原則
* 多対多リレーションの適切な実装
* データ整合性の確保（CASCADE削除、制約）
* パフォーマンス最適化（インデックス設計）
* セキュリティ考慮（外部キー制約）

---

## 🔌 API設計

### 認証API（✅実装完了）
* `POST /auth/login` - パスワード認証によるログイン
* `POST /auth/register` - 新規ユーザー登録（パスワード認証）
* `POST /auth/email/send-code` - メール認証コード送信
* `POST /auth/email/verify-code` - メール認証コード検証
* `POST /auth/email/resend-code` - メール認証コード再送信
* `GET /auth/verify` - 認証確認（JWTトークン検証）

### ユーザーAPI
* `GET /users/me` - 自分の情報取得
* `PUT /users/me` - 自分の情報更新

### タグ管理API
* `GET /tags` - タグ一覧取得
* `POST /tags` - タグ作成
* `GET /users/me/tags` - 自分のタグ一覧
* `POST /users/me/tags` - 自分のタグに追加
* `DELETE /users/me/tags/{tag_id}` - 自分のタグから削除

### いいね・マッチングAPI
* `POST /likes` - いいね送信
* `GET /likes/sent` - 送信したいいね一覧
* `GET /likes/received` - 受け取ったいいね一覧
* `GET /matches` - マッチしたユーザー一覧

### ユーザー検索API
* `GET /users/search` - ユーザー検索・フィルタリング
* `GET /users/suggestions` - おすすめユーザー取得

### チャットAPI（✅実装完了）
* `GET /conversations` - 会話一覧取得
* `POST /conversations` - 会話作成
* `GET /conversations/{id}/messages` - メッセージ履歴取得
* `POST /conversations/{id}/messages` - メッセージ送信（テキスト）
* `WS /ws` - WebSocket接続（リアルタイム通信）
* `WS /ws/{conversation_id}` - 会話専用WebSocket接続

### ファイルアップロードAPI（✅実装完了）
* `POST /files/upload/voice` - 音声ファイルアップロード
* `POST /files/upload/image` - 画像ファイルアップロード
* `POST /files/upload/avatar` - アバター画像アップロード
* `GET /files/{file_path}` - ファイル取得

### セーフティAPI
* `POST /reports` - ユーザー通報
* `POST /blocks` - ユーザーブロック
* `GET /blocks/my` - ブロック一覧取得
* `DELETE /blocks/{user_id}` - ブロック解除

---

## 🎨 UI/UX要件

### デザイン原則
* **匿名性**: 顔出し不要、プライバシー保護
* **安全性**: セーフティ機能の充実
* **使いやすさ**: 直感的な操作
* **レスポンシブ**: モバイル・デスクトップ対応

### 主要画面
* ランディングページ（未認証ユーザー向け紹介ページ）
* ログイン・プロフィール登録画面
* ホーム画面（ユーザー一覧・検索）
* プロフィール画面（表示・編集）
* マッチ一覧画面
* チャット画面
* 設定画面

### Figmaデザイン活用
* デザインシステムの構築
* コンポーネントベースの開発
* デザイントークンの抽出・活用

---

## 🔒 セキュリティ要件

### 認証・認可
* JWT認証によるセキュアなセッション管理
* 九州大学メールアドレスでの認証
* 適切な権限管理

### データ保護
* 個人情報の適切な管理
* メッセージ内容の保護
* 通報・ブロック情報の管理

### セーフティ機能
* 不適切行為の通報機能
* ブロック機能による相互作用制限
* 管理者による適切な対応

---

## 📈 実装計画（ロードマップ）

### Phase 1: 基盤構築（完了）
* [x] GitHubリポジトリ構築
* [x] FastAPI + PostgreSQL 接続
* [x] ユーザーモデル・CRUD実装
* [x] 認証システム実装
* [x] データベースモデル設計・実装
* [x] Alembicマイグレーション導入

### Phase 2: バックエンドAPI実装（✅完了）
* [x] タグ管理API実装
* [x] いいね・マッチングAPI実装
* [x] ユーザー検索・フィルターAPI実装
* [x] チャットAPI実装
* [x] 通報・ブロックAPI実装

### Phase 3: フロントエンド実装（✅完了）
* [x] プロジェクトセットアップ
* [x] デザインシステム構築
* [x] ランディングページ実装
* [x] 認証・プロフィール画面実装
* [x] ユーザー検索画面実装
* [x] マッチング画面実装
* [x] チャット画面実装

### Phase 4: 統合・テスト（✅完了）
* [x] フロントエンド・バックエンド統合
* [x] 総合テスト（バックエンド22テスト + フロントエンド28テスト）
* [x] セキュリティテスト（実装済み）
* [x] パフォーマンステスト（ガイドライン作成済み）

### Phase 5: デプロイ・運用（✅完了）
* [x] 本番環境構築（Render + Vercel）
* [x] デプロイ自動化（GitHub連携による自動デプロイ）
* [x] 監視・ログ設定（Sentry統合完了）
* [x] 環境変数管理（Render/Vercel環境変数設定）
* [x] データベースマイグレーション自動化（Alembic）
* [ ] ユーザーフィードバック収集（準備中）
* [ ] 運用保守マニュアル作成（推奨）

### Phase 6: 拡張機能（✅一部完了）
* [ ] n8n連携（AI自動タグ生成）
* [x] リアルタイム通信（WebSocket実装済み）
* [x] 音声メッセージ機能（実装済み）
* [x] ファイルアップロード機能（実装済み）
* [x] PWA対応（実装済み）
* [ ] プッシュ通知機能（基盤準備済み）
* [ ] 統計・分析機能

---

## 📂 プロジェクト構成

```
qupid-app/
├── app/                    # バックエンド（FastAPI）
│   ├── core/              # コア機能（設定、認証、セキュリティ）
│   ├── db/                # データベース関連
│   ├── models/            # SQLAlchemyモデル
│   ├── routers/           # APIエンドポイント
│   ├── schemas/           # Pydanticスキーマ
│   └── main.py            # アプリケーションエントリーポイント
├── docs/                  # ドキュメント
│   ├── implementation-plans/  # 実装計画書
│   └── requirements.md    # 要件定義書
├── frontend/              # フロントエンド（予定）
├── alembic/               # データベースマイグレーション
├── compose.yml            # Docker Compose設定
├── Dockerfile             # Dockerイメージ設定
└── requirements.txt       # Python依存関係
```

---

## 🎯 成功指標

### 技術指標
* [x] 全APIエンドポイントが正常に動作
* [x] テストカバレッジ53%（バックエンド）、28テスト（フロントエンド）
* [ ] テストカバレッジ80%以上（目標）
* [ ] レスポンス時間500ms以下（パフォーマンステスト推奨）
* [x] セキュリティ要件を満たす（Sentry監視、CORS設定、JWT認証）

### ビジネス指標
* [ ] 九州大学学生の利用開始
* [ ] マッチング成立数の増加
* [ ] ユーザーフィードバックの収集
* [ ] セーフティ機能の適切な動作

---

## 🔄 次のステップ

1. **運用保守体制の構築** - 運用マニュアル作成、監視設定の最適化
2. **テストカバレッジの向上** - 80%以上を目標にテスト追加
3. **パフォーマンス最適化** - 負荷テスト実施、ボトルネック改善
4. **機能拡張** - プッシュ通知、統計・分析機能の実装
5. **ユーザーフィードバック収集** - ベータテスト開始、改善サイクル確立

---

## 📚 関連ドキュメント

* [タグ管理API実装計画書](./implementation-plans/01-tag-management.md)
* [いいね・マッチングAPI実装計画書](./implementation-plans/02-like-matching.md)
* [ユーザー検索・フィルターAPI実装計画書](./implementation-plans/03-user-search.md)
* [チャットAPI実装計画書](./implementation-plans/04-chat-api.md)
* [通報・ブロックAPI実装計画書](./implementation-plans/05-report-block.md)

---

**作成日**: 2025年10月13日
**最終更新日**: 2025年1月（実装状況反映）
**担当者**: Qupid開発チーム

## 📝 更新履歴

* **2025年2月**: ユーザーフィードバック（中村氏）対応：並び替えをフィルターなし時もsuggestions APIで対応、フィルター「タグ」の動作修正、プライバシー設定にキャンパス追加・体の性別の説明追加・ナビにプライバシー設定を追加、プロフィールの「探している関係」を複数選択可能に・表記を「探している関係」に統一、探す画面グリッドにavatar_url表示、プロフィールプレビューモーダルに「戻る」ボタン追加
* **2025年1月**: ランディングページ実装完了を追加、実装完了状況を反映、新機能（音声メッセージ、ファイルアップロード、PWA、WebSocket）を追加、デプロイ状況を更新
* **2025年10月15日**: 初期版作成

